---
applyTo: "**"
---

# コードレビューのチェックリスト（ミライシード用）

- Respond in Japanese
- 以下のチェックリストは、ミライシードのコードレビューにおいて確認すべき項目をまとめたものです。

## コードスタイル

- コーディング規約に沿って成果物が作成されている
  - 規約リンク: [Javaコーディング規約](./benesse-java-dev-manual.instructions.md)
- 例外処理が正しく行なわれていること
  - catch後の処理が正しいか
    - `Exception.printStackTrace()`は使用しない
  - 適切なExceptionでキャッチもしくはthrowされているか
  - 最終的にはExceptionクラスでキャッチされているか
  - メソッド内で発生しない例外をcatchもしくはthrows句として記述していないか
- 共通化できる処理が共通化されていること
- 推奨されていない変数・メソッドは使用していないこと
- 変数、オブジェクトに対する処理はNullPointerExceptionが考慮されていること
- String変数の取りうる文字数を考慮して、プログラミングしていること。Substring関数など。
  - 値がNullの時、想定より文字数が足りない場合の考慮がされていること
- 定数は共通化されていること
- 型の最大値を越えるようなロジックが記述されていないこと
  - オラクルシーケンス使用時に特に注意すること
- アクセス制限が適切であること
  - 同クラス内でしか呼ばれないメソッドはprivate
- スコープが適切であること
  - NG例1: 特定のメソッドでしか使ってないのにクラス変数になっている。
  - NG例2: 様々なクラスメソッドで使っているのにグローバル変数になっていない。
- メモリを消費するようなロジックが記述されていないこと
  - 不要なキャストをしている 例Stringオブジェクトにあえて（String）をつける
  - 文字列を「＋」で連結している
  - ループ処理(for文・while文)の中で不必要なオブジェクトを生成している
  - ループ処理(for文・while文)の中に大量の処理を記述している
  - ファイルを開いたままfinally処理で閉じていない
- 文字列比較にはequalsメソッドが使用されていること
  - NG例: `if(kbn == "app") { ・・・ }`
- 文字列変換で、C#の文字列変換メソッド(Strings.StrConv)はShift-JISコード表にある漢字しか対応していないため、漢字を含む文字列には使用しないこと
- 文字列変換は、JavaとC#で仕様が異なる（※1・2）ので、安易にググるのではなくまずミライシード内で利用しているものを確認すること
  - 1. Java：Normalizer.normalize、C#：Strings.StrConv
  - 2. 例えば、「①」はJavaだと「1：半角数字」で、C#だと「①：記号のまま」となる
- Javaの文字取得メソッド（String.charAt）は、4バイト文字（サロゲートペア）に対応していないため、4バイト文字を取得する場合はコードポイントを使う
- forthWeb、forthBatchコンテキストでは、Actionメソッドごとにデータソースアノテーションの追記は不要
  - ※マスタースレーブ構成時の記載が残っているが現在は機能していないため不要
  - 既存をコピーして記載を増やさないように注意
  - 不要な記載: `@SelectDataSource(SelectDataSource.DataSourceType.SLAVE)`
  - 不要な記載: `@SelectDataSource(SelectDataSource.DataSourceType.MASTER)`
- 不要なクラスがインポートされていいないこと(備考※1)
- 不要な変数が定義されていないこと
- 標準出力が使用されていないこと
  - `Exception.printStackTrace()`、`System.out.println()` 等
- if文にelseがテストケースとして設定されていること(else記載がなくても条件網羅されていること)
  - 例:

    ```java
    ret = 0;
    if(hoge == 1){ ret = 100;}
    ```

    C0観点でのカバレッジの場合、条件網羅がされない。
    何も処理をしない場合、コードにelseの記載は不要だが、単テ条件には必ず含めること

- javadocコメントが記述されていること
  - 新規メソッドに対する追加漏れがないこと
  - 改修による処理変更がコメントに適用されていること
- 影響チェックができていること
  - 呼び出し元のチェックができていること。
  - ドリルパークの場合、Actionメソッド間の遷移がべた書きのケースがあるため開発ツールの呼び出し元参照で検索できないケースがあるため要注意

## ログ

- 関数の開始と終了時にログが出力されていること
  - LogInfoInterceptor.javaでActionメソッド単位に自動で出力される。
  - 実装考慮は不要だがログが出力されていることは確認すること。
- ログを出力するタイミング・内容・レベルが妥当であること
  - Debugレベルは本番環境では出力されない。
  - 本番調査に必要な内容はInfoレベル以上で出力すること、ただしログ出力によりサーバ容量を圧迫するような作りにしないこと。

## 整合性

- 設計書に記述された内容が漏れなく処理されていること
  - 実装段階での設計変更が必要な場合反映すること※再レビュー必須
  - 設計は行単位にコードと突き合わせて確認すること
- 設計書に記述されていない内容が処理されていないこと
  - 実装段階での設計変更が必要な場合反映すること※再レビュー必須
  - 設計は行単位にコードと突き合わせて確認すること

## ソース管理

- 更新・追加・削除したファイルをgithubにコミットしたか
  - 単体テスト完了段階でチェックすること
- 全環境の設定ファイルに変更内容を反映しているか。特にresourceフォルダ配下に注意。
  - _release
  - _pkg
  - _dev1_s01
  - _dev1_s11
  - _dev2_s01
  - _dev2_s11
  - _dev3_s01
  - _dev3_s11
- シークレット情報の設定は_@～～@_で囲まれた変数でマスクされた状態でコミットすること※gitLeaksでプレコミットして確認を行うこと
  - 暗号化・復号キーのハッシュ値やDB接続情報などが対象※誤って生値をコミットした場合は早急にPL・PMに報告すること
  - 例：webapi_hash=_@MASK_TARGET_WEBAPI_HASH@_
- 環境ごとの設定は_@～～@_で囲まれた変数でマスクされた状態でコミットすること
  - ホスト名・面ごとの閾値などが対象
  - 例：kanji.recognizer.host_dev=_@KANJI_RECOGNIZER_HOST@_
- マスク対象が増えた場合は、ansible-new-deployリポジトリに対してマスク解除の実装すること
  - [秘匿情報の扱いについて](https://www.notion.so/0b6cd057559b41f99f9ba29b6b10bd0f)
- デバッグ用のダミーページ等が含まれコミットされていないか。 後続テストで必要な場合、対象コードの削除タイミングは案件内で合意できており、WBSにも反映されているか
  - ダミーログイン用のページがコミットされてリリースまでしてしまったケースがある

## ロジック

- 日付を扱うロジックで、時刻における12時間（AM、PM）、24時間の考慮が正しいこと。
  - Javaのフォーマットの場合HHとhh
  - SQLで日付を扱う場合HHとHH24
- 年度・年・月・日の操作（翌日や１年後の日付を求める等）を行うロジックが正しく処理されているか
  - 年上がり、月上がりなど。
- 年度・年・月・日を元にした操作（一部を切出して利用する等）が正しく処理されているか
  - 2024年度の対象の抽出で日付の年だけ切り出して確認してしまい、2025/01/01～が対象になっていないなどの実装がないか。などの考慮
- Seed・SeedBatchはDateUtileクラスを利用して現在日時を取得していること
  - テスト用の現在日付変更機能を使うために該当クラスにコーディングされている。
  - DBのカレント日付や、サーバの日付をとるような実装がされていないこと

## 共通

- セッションに格納するオブジェクトはシリアライズされていること
  - 例） Dtoクラスなどはimplements Serializableが記載、または記載されたクラスを継承していること
- セッションの内容を変更した場合、改めてセッションにセットするコードを記述すること
  - ログイン時のセッション情報など、次画面で変わるような挙動があった場合、画面内で完結するのではなく、セッションに詰め忘れないこと。
  - 例：ログイン後、次画面でサブクラスを選択してログインクラスが変わる場合など
- セッションに大量データを保存しないこと
  - 巨大なSQLの応答結果をセッションに保存するなどがないこと※サーバ負荷につながるため
- 【html・jsp・css・js】htmlコメント・JSPコメント等の使い分けがされていること
  - `<%-- JSPのコメント --%>`: クライアントに表示されない
  - `<!-- HTMLのコメント -->`: クライアントに表示されるため原則NG
- 【html・jsp・css・js】全ての画像にaltが設定されていること
- 【html・jsp・css・js】タグの対応が正しいこと、閉じ忘れがないこと
  - importしたクラスでタグが開始／終了されている場合もあるので注意
   	- ファイル単位きちんと閉じること。
- 【html・jsp】ヘッダータグ（keywords、description、title）の記述が適切であること
  - 画面を見ただけでは判別できないので注意※metaタグなど
- 【html・jsp】div、spanタグ等のHTMLタグ閉じ忘れがないか
- 【jsp】jsp内にjavaで難易度の高いロジックを埋め込まないこと
  - 軽微ロジックであれば許容だが、集計など複雑なロジックの場合は、ロジッククラスで実装し、値を渡すこととする。
  - NG例:

  ```jsp
  <%
  String[] array = {"hoge", "fuga", "boo" };
  Date date = new Date();
  SimpleDateFormat sdf = new SimpleDateFormat("yyyy/MM/dd");
  String today = sdf.format(date);
  %>
  ```

- 【html・jsp・js・css】ファイル拡張子単位に正しい役割の記載がされていること
  - HTML・JSPの中にjsを直接書かないこと。Jsファイルに分けること。
  - ※HTML・JSPの中にスタイル指定を極力直接書かないこと。cssファイルに分けること。
- forth_system_batch.propertiesを変更する場合、forth_system_batch.properties_devも変更すること

## ファイル入出力

- ファイル、ディレクトリに対する処理で、書込、読込、実行権限に支障が発生しないプログラムになっているか。
  - ファイル、フォルダの書き出し時の権限は設計時に合意していること。
  - 権限がない場合、対象パスとエラー内容がわかるようなログを吐き出しているか。
  - 権限がない場合、ファイルサーバとDBの情報に差異が発生するような実装になっていないか。
  - 権限がないなどのシステムエラーの場合、ユーザへの表示はどうするかを事業部と合意しているか。
- オープンしたストリームは、正常終了、異常終了に限らず必ずクローズされているか。※メモリリーク対策
  - try-with-resources構文を利用している：OK
  - 上記を利用していないが、finally内で閉じられている場合：OK
  - 上記を利用しておらず、catch内やtryの最後でしかクローズしていない:NG
    - ※tryの途中でReturnした場合クローズされない
  - C#のみ：usingを利用している：OK
- ファイル入出力時の文字コード、改行コードが設計書通り指定していること。※単体テストで出力文字コードを必ず確認すること
  - OK例：`new OutputStreamWriter(new FileOutputStream(file),"Shift-JIS")`
  - 文字コードを指定して読み込み、書き込みがされていること
    - DBへの入出力はフレームワークで実施されていること
    - EXCELへの入出力はライブラリーで指定が実施されていること
- 分岐条件が正しいこと。
- 例外時のメッセージに正しいものが設定されていること
- 必要なチェック処理の漏れがないか

## DB接続

- finallyでコネクション、ステートメント、レザルトセットがクローズされていること
  - 基本はSeasar・Springフレームワークで管理されるため明示的に指定は不要。ただし任意でコネクションを管理する場合は、必須（バッチで学校単位にトランザクションを切るケースなど）
  - try-with-resources構文の利用でもOK
- トランザクション処理にてデッドロックが発生するようなロジックが記述されていないこと
  - DBのテーブル処理順番が類件機能と一致していること。
    - NG例
      - メソッドA：Aレコード処理→Bレコード処理→Cレコード処理
      - メソッドB：Aレコード処理→Cレコード処理→Bレコード処理
- DB登録/削除処理にてエラーが発生した場合はロールバック処理が記述されていること
  - 基本はSeasar・Springフレームワークで管理されるため明示的に指定は不要
  - 任意でコネクションを管理する場合は、必須
- RequiresNewの多用によりDBコネクションを圧迫する作りになっていないこと
  - 任意でコネクションを管理する場合は、チェック必須

## SQL文

- preparedStatementクラスで、バインドして使用していること
  - sqlインジェクション対策
  - NG例：リクエスト値をSQLにべた書き
    - `"select * from hoge where id = "+req.getParameter("id");`
- 副問合せはできる限り、使用していないこと
  - 参考：https://qiita.com/SSKNOK/items/5dc5b02133b188e48676
- JOIN結合をする際は、条件を絞ってから使用すること
  - 参考：https://www.w2solution.co.jp/corporate/tech/eg_ti_ti_sql5/
- 複数レコード取得されるSQLは、設計書通りにソート（昇順・降順）されていること
  - 表示順が設計に未記載の場合、独自判断ではなく必ず事業部に確認すること
- 検索条件がNULLの際は、<>ではなく、ISNULL文で検索すること
- Clob型のテーブル操作を実施する際は、Clob型を使用し、500文字（1024バイト）以下ずつ書き込みが行われていること。守られていないと文字化けしてしまう
  - Good例

  ```java
  rs = ps.executeQuery();
  Clob c1 = rs.getClob(""カラム名"");
  setClob(c1, pcText);
  private static void setClob(Clob c1, String data) throws Exception{
         int i = 1;
         for (int j = 0; j < data.length(); ){
          if ((j + 500) >= data.length()) {
           i += c1.setString(i, data.substring(j));
          } else{
           i += c1.setString(i, data.substring(j, j + 500));
          }
          j += 500;
         }
  }
  ```

- delete文・update文作成時は、条件が正しいか慎重に確認すること
  - テスト環境でも、必要なデータを削除してしまうことがあるため注意
- in句などパラメータ上限DBサーバ上の指定があるものは考慮すること ※1000件ずつ取得するなど
- SQL発行がjavaのループ内で何度も発行されるような作りになっていないこと（N＋1）
  - NG：

  ```plain
  モジュールリスト取得SQL発行
  ループ１（モジュールリスト）スタート
    モジュールIDでSQL発行
    内部処理
  ループ１エンド
  ```

  - OK：

  ```plain
  モジュールリスト取得SQL発行
  モジュールIDでSQL発行（INで取得）
  ループ１（INで取得したリスト）スタート
    内部処理
  ループ１エンド
  ```

- SQL内で固定文字列を生成しない事（caseを利用した条件分岐等）
  - ロジックは極力Javaのロジックに含める
  - 例）`CASE WHEN t2.use_type='basic' THEN 'ベーシックドリル' ELSE 'パワーアップドリル' END as use_type_name`
- 実行計画が問題ないこと
  - 必要に応じて本番で低負荷時間帯に実行計画を取得して確認すること
  - 必要に応じてINDEXの追加も検討を行うこと
  - 一般的な実行計画確認方法: https://qiita.com/yoshinori_hisakawa/items/5ef0cf4fd8eb6dd3037f
-	SQLファイルの先頭にコメントでファイル名記載
 	- Jennifer等での調査性UP

## seasar

- サービスクラス内のクラス変数としてインスタンス変数を使用していないか(レースコンディション対応)
  - セッションが共有化されるケースがあり個人情報漏洩につながるため要注意
  - レースコンディションとは: https://www.securify.jp/blog/race-condition/
  - インスタンス変数、クラス変数の違い: https://qiita.com/tta0206/items/74059f904fd967526d9b
  - NG例
    - クラス変数に`private static String buttonName = "";`
- ホットデプロイになっていないこと
  - 新規コンテキスト作成時に要注意（基本はミドルウェア・フレームワークの設定となる）既存に手を入れる程度であれば対象外
- queryアノテーションでselectを使用したい場合はsqlファイルを使用すること
  - 適切なDaoクラスにメソッド追加すること
  - javaにSQLをjavaファイルにべた書きしない
