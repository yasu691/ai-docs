---
applyTo: '**'
---

# Next.js ベストプラクティス

この文書では、Next.jsアプリケーションの構築、構造化、保守における最新の権威あるベストプラクティスをまとめています。LLMと開発者がコード品質、保守性、スケーラビリティを確保するために使用することを目的としています。

---

## 1. プロジェクト構造と組織化

- すべての新規プロジェクトでは `app/` ディレクトリ（App Router）を使用する。レガシーな `pages/` ディレクトリよりも優先する。
- トップレベルフォルダ：
  - `app/` — ルーティング、レイアウト、ページ、ルートハンドラー
  - `public/` — 静的アセット（画像、フォントなど）
  - `lib/` — 共有ユーティリティ、APIクライアント、ロジック
  - `components/` — 再利用可能なUIコンポーネント
  - `contexts/` — Reactコンテキストプロバイダー
  - `styles/` — グローバルおよびモジュラースタイルシート
  - `hooks/` — カスタムReactフック
  - `types/` — TypeScript型定義
- コロケーション： ファイル（コンポーネント、スタイル、テスト）は使用される場所の近くに配置するが、深くネストした構造は避ける。
- ルートグループ： URLパスに影響を与えることなくルートをグループ化するには括弧を使用する（例：`(admin)`）。
- プライベートフォルダ： ルーティングから除外し、実装詳細を示すには `_` でプレフィックスを付ける（例：`_internal`）。

- フィーチャーフォルダ： 大規模なアプリの場合、機能別にグループ化する（例：`app/dashboard/`、`app/auth/`）。
- `src/` の使用（オプション）：設定ファイルから分離するため、すべてのソースコードを `src/` に配置する。

## 2.1. サーバーコンポーネントとクライアントコンポーネントの統合（App Router）

サーバーコンポーネント内で `{ ssr: false }` オプション付きの `next/dynamic` を使用してはいけない。これはサポートされておらず、ビルド/ランタイムエラーを引き起こす。

正しいアプローチ：

- サーバーコンポーネント内でクライアントコンポーネント（フック、ブラウザAPI、クライアント専用ライブラリを使用するコンポーネント）を使用する必要がある場合は、以下を行う必要がある：
  1. すべてのクライアント専用ロジック/UIを専用のクライアントコンポーネント（先頭に `'use client'` を付ける）に移動する。
  2. そのクライアントコンポーネントをサーバーコンポーネントで直接インポートして使用する（`next/dynamic` は不要）。
  3. 複数のクライアント専用要素（例：プロフィールドロップダウン付きのナビゲーションバー）を組み合わせる必要がある場合は、それらすべてを含む単一のクライアントコンポーネントを作成する。

例：

```tsx
// サーバーコンポーネント
import DashboardNavbar from '@/components/DashboardNavbar';

export default async function DashboardPage() {
  // ...サーバーロジック...
  return (
    <>
      <DashboardNavbar /> {/* これはクライアントコンポーネント */}
      {/* ...残りのサーバーレンダリングページ... */}
    </>
  );
}
```

理由：

- サーバーコンポーネントではクライアント専用機能やSSRを無効にした動的インポートを使用できない。
- クライアントコンポーネントはサーバーコンポーネント内でレンダリングできるが、その逆はできない。

まとめ：
常にクライアント専用UIをクライアントコンポーネントに移動し、サーバーコンポーネントで直接インポートする。サーバーコンポーネントで `{ ssr: false }` 付きの `next/dynamic` を使用してはいけない。

---

## 2. コンポーネントのベストプラクティス

- コンポーネントの種類：
  - サーバーコンポーネント（デフォルト）：データフェッチ、重いロジック、非インタラクティブUIに使用。
  - クライアントコンポーネント： 先頭に `'use client'` を追加。インタラクティビティ、状態、ブラウザAPIに使用。
- コンポーネントを作成するタイミング：
  - UIパターンが複数回再利用される場合。
  - ページのセクションが複雑または自己完結している場合。
  - 可読性やテスト性が向上する場合。
- 命名規則：
  - コンポーネントファイルとエクスポートには `PascalCase` を使用（例：`UserCard.tsx`）。
  - フックには `camelCase` を使用（例：`useUser.ts`）。
  - 静的アセットには `snake_case` または `kebab-case` を使用（例：`logo_dark.svg`）。
  - コンテキストプロバイダーは `XyzProvider` として命名（例：`ThemeProvider`）。
- ファイル命名：
  - コンポーネント名とファイル名を一致させる。
  - 単一エクスポートファイルの場合、コンポーネントをデフォルトエクスポートする。
  - 複数の関連コンポーネントの場合、`index.ts` バレルファイルを使用する。
- コンポーネントの場所：
  - 共有コンポーネントは `components/` に配置。
  - ルート固有のコンポーネントは関連するルートフォルダー内に配置。
- プロパティ：
  - プロパティにはTypeScriptインターフェースを使用。
  - 明示的なプロパティ型とデフォルト値を優先。
- テスト：
  - テストをコンポーネントと同じ場所に配置（例：`UserCard.test.tsx`）。

## 3. 命名規則（全般）

- フォルダ： `kebab-case`（例：`user-profile/`）
- ファイル： コンポーネントは `PascalCase`、ユーティリティ/フックは `camelCase`、静的アセットは `kebab-case`
- 変数/関数： `camelCase`
- 型/インターフェース： `PascalCase`
- 定数： `UPPER_SNAKE_CASE`

## 4. APIルート（ルートハンドラー）

- 超低レイテンシや地理的分散が必要でない限り、Edge Functionsよりもapi ルートを優先する。
- 場所： APIルートは `app/api/` に配置（例：`app/api/users/route.ts`）。
- HTTPメソッド： HTTPメソッド名の非同期関数をエクスポート（`GET`、`POST`など）。
- リクエスト/レスポンス： Web `Request` および `Response` APIを使用。高度な機能には `NextRequest`/`NextResponse` を使用。
- 動的セグメント： 動的APIルートには `[param]` を使用（例：`app/api/users/[id]/route.ts`）。
- バリデーション： 常に入力を検証・サニタイズする。`zod` や `yup` などのライブラリを使用。
- エラーハンドリング： 適切なHTTPステータスコードとエラーメッセージを返す。
- 認証： ミドルウェアまたはサーバーサイドセッションチェックを使用して機密ルートを保護。

## 5. 一般的なベストプラクティス

- TypeScript： すべてのコードにTypeScriptを使用。`tsconfig.json` で `strict` モードを有効にする。
- ESLint & Prettier： コードスタイルとリンティングを強制。公式Next.js ESLint設定を使用。
- 環境変数： 秘密情報は `.env.local` に保存。秘密情報をバージョン管理にコミットしない。
- テスト： Jest、React Testing Library、またはPlaywrightを使用。すべての重要なロジックとコンポーネントのテストを作成。
- アクセシビリティ： セマンティックHTMLとARIA属性を使用。スクリーンリーダーでテスト。
- パフォーマンス：
  - 組み込みのImageとFontの最適化を使用。
  - 非同期データにSuspenseとローディング状態を使用。
  - 大きなクライアントバンドルを避ける；ほとんどのロジックをサーバーコンポーネントに保持。
- セキュリティ：
  - すべてのユーザー入力をサニタイズ。
  - 本番環境でHTTPSを使用。
  - 安全なHTTPヘッダーを設定。
- ドキュメンテーション：
  - 明確なREADMEとコードコメントを作成。
  - パブリックAPIとコンポーネントを文書化。

# 不要なサンプルファイルの回避

ユーザーが具体的にライブサンプル、Storybookストーリー、明示的なドキュメンテーションコンポーネントを要求しない限り、メインコードベースにサンプル/デモファイル（ModalExample.tsxなど）を作成しない。デフォルトでリポジトリをクリーンで本番向けに保つ。

# 常に最新のドキュメンテーションとガイドを使用

- Next.js関連のすべてのリクエストについて、まず最新のNext.jsドキュメンテーション、ガイド、サンプルを検索する。
- 利用可能な場合は、以下のツールを使用してドキュメンテーションを取得・検索する：
  - `resolve_library_id` を使用してドキュメント内のパッケージ/ライブラリ名を解決。
  - `get_library_docs` を使用して最新のドキュメンテーションを取得。
