---
title: 'コードコメント追加'
mode: 'agent'
description: 'リポジトリのソースコードとドキュメントを確認し、Why中心の手厚いコメントを追加するコマンドです。'
---

# コードコメント追加 指示

以下の手順とガイドラインに従い、リポジトリ全体のソースコードに "Why" を中心とした詳細なコメントを追加してください。コメント追加後は必ずプルリクエストを作成し、レビュアが差分を確認しやすいようにしてください。

## 目的
- **理解容易性の向上**: 後続の開発者がコード意図を即座に理解できるようにする。
- **保守性の向上**: 仕様変更やバグ修正時の手掛かりを増やし、メンテナンスコストを削減する。
- **ドキュメントとの一貫性**: `docs/` 以下の設計ドキュメントとコメント内容を同期させ、コードとドキュメントの乖離を防ぐ。

## コメント追加方針
1. **Why を中心に**: 処理の意図・背景・トレードオフを明確にする。What の逐語説明は最小限。
2. **KISS / DRY / YAGNI** の原則を守り、冗長なコメントは避ける。
3. **言語・フレームワークに適した形式**:
   - Python: Google Style Docstring
   - TypeScript/JavaScript: JSDoc
   - Shell/Bash: 行頭 `#` のプレフィクス
4. **コメントとコードの乖離防止**: ビジネスロジック変更時はコメント更新を必須とする旨をコメント内に TODO で明示。
5. **セキュリティ視点の補足**: 外部入出力箇所には入力バリデーションと潜在的リスクをコメントに記載。
6. **ログに紐付く ID**: 重要処理にはログ行番号や Correlation ID の発生源を示すコメントを追加。

## 具体的な作業手順
1. **対象ファイルの抽出**
   - `src/`, `backend/`, `frontend/`, `.py`, `.ts`, `.js` など主要ディレクトリ・拡張子を対象にする。
2. **既存コメントのレビュー**
   - 重複・陳腐化・誤情報を削除 or 修正。
3. **関数・メソッド単位でコメント追加**
   - 入出力、例外、事前条件/事後条件、なぜそのアルゴリズムなのかを説明。
4. **クラス・モジュールレベルの概要コメント**
   - 役割、他モジュールとの依存関係、公開 API を記載。
5. **インラインコメント**
   - 複雑な計算・条件分岐には 1~2 行で要点を補足。
6. **ドキュメント同期チェック**
   - 追加したコメントが `docs/` 内の ADR や設計書と矛盾しないか確認。
7. **コミット & PR**
   - コミットメッセージ: `feat(comment): Add detailed Why comments across codebase`
   - PR テンプレに作業概要とレビューポイントを記載。

## コメントテンプレート例
```python
def process_payment(order: Order) -> Receipt:
    """注文情報をもとに決済を実行し、レシートを生成する。

    Why:
        - 決済処理をドメインサービスに集約し、副作用を最小化。
        - 外部 Payment API とのインタラクションを一元化し、変更影響範囲を限定。

    Args:
        order (Order): 決済対象の注文モデル。

    Returns:
        Receipt: 決済完了後に生成される領収書モデル。

    Raises:
        PaymentError: 決済失敗時に発生。
    """
    # API レスポンスの整合性を保証するため、事前に schema validation を実施する
    response = payment_gateway.charge(order)
    # ...
```

```ts
/**
 * ユーザー設定をローカルストレージへ保存する。
 *
 * Why:
 *   - ブラウザリロード時に設定を保持し、UX を向上させるため。
 *   - サーバーラウンドトリップを避け、パフォーマンスを最適化。
 *
 * @param settings - 保存対象のユーザー設定オブジェクト
 * @throws {QuotaExceededError} ストレージ容量オーバー時
 */
export function saveSettings(settings: UserSettings): void {
  // JSON.stringify の結果が大きくなる可能性があるため、事前にサイズチェックを行う
  localStorage.setItem('app:settings', JSON.stringify(settings));
}
```

## 完了条件
- 主要ソースファイルの 80% 以上に Why ベースのコメントが追加されている。
- `npm test` / `pytest` など既存テストがすべてパスする。
- PR が作成され、コードレビューで指摘がないレベルの品質を満たす。
